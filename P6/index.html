<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <script src="http://d3js.org/d3.v4.min.js"></script>
    <script src="http://dimplejs.org/dist/dimple.v2.3.0.min.js"></script>
    
    <style>
      h2 {
        text-align: center;
      }
      h3 {
        text-align: center;
      }
      svg {
        margin: auto;
        display: block;
      }
      text.quadrant-label {
        font-size: "16px";
      }
    </style>

    <script type="text/javascript">
        
        "use strict";

        var PCT_FORMAT = ".0%";
        var MIN_RADIUS = 7;
        var CIRCLE_FILL_COLOR = "#80B1D3";
        var CIRCLE_STROKE_COLOR = "#40647c";
        var CIRCLE_OPACITY = 0.8;

        /**
         * return the weighted mean of the resolution time
         * @param {array} data - the data object
         */
        function resolutionTime(data) {
            var total = d3.sum(data, function(d) { return d.n; });
            return d3.sum(data, function(d) { return d.n / total * d.median; });
        }

        /**
         * return the weighted mean of the resolution rate
         * @param {array} data - the data object
         */
        function resolutionRate(data) {
            var total = d3.sum(data, function(d) { return d.n; });
            return d3.sum(data, function(d) { return d.n / total * d.freq; });
        }

        /**
         * return name of the state given the code
         * @param {array} data - the data object
         * @param {string} code - the state code
         */
        function findStateByCode(data, code) {
            for (var i=0; i < data.length; i++) {
                if (data[i].state == code) {
                    return data[i].stateName;
                }
            }
            return null;
        }

        /**
         * append text labels l1 and l2 in the position x, y
         * @param {array} data - the data object
         */
        function drawQuadrantLabels(svg, x, y, l1, l2, anchorH, anchorV) {
            svg.append("text")
                .attr("class", "quadrant-label")
                .attr("x", x)
                .attr("y", y)
                .attr("dy", "0em")
                .attr("text-anchor", anchorH)
                .attr("alignment-baseline", anchorV)
                .text(l1 + " resolution rate");
            svg.append("text")
                .attr("class", "quadrant-label")
                .attr("x", x)
                .attr("y", y)
                .attr("dy", "1em")
                .attr("text-anchor", anchorH)
                .attr("alignment-baseline", anchorV)
                .text(l2 + " resolution time");
        }

        /**
         * add the vertical line
         */
        function addVerticalLine(svg, myChart, x, value, label) {
            var xIntercept = x._scale(value); 
            svg.append("line")
                .attr("x1", xIntercept)
                .attr("y1", myChart._yPixels())
                .attr("x2", xIntercept)
                .attr("y2", myChart._yPixels() + myChart._heightPixels())
                .style("stroke", "red")
                .style("stroke-dasharray", "3");
            svg.append("text")
                .attr("x", xIntercept)
                .attr("y", myChart._yPixels() - 2)
                .attr("text-anchor", "middle")
                .text(label);
            svg.append("text")
                .attr("x", xIntercept)
                .attr("y", myChart._yPixels() + myChart._heightPixels() + 15)
                .attr("text-anchor", "middle")
                .text(d3.format(PCT_FORMAT)(value));
        }

        /**
         * add the horizontal line
         */
        function addHorizontalLine(svg, myChart, y, value, label) {
            var yIntercept = y._scale(value); 
            
            svg.append("line")
                .attr("x1", myChart._xPixels())
                .attr("y1", yIntercept)
                .attr("x2", myChart._xPixels() + myChart._widthPixels())
                .attr("y2", yIntercept)
                .style("stroke", "red")
                .style("stroke-dasharray", "3");
            svg.append("text")
                .attr("x", myChart._xPixels() + myChart._widthPixels())
                .attr("y", yIntercept - 4)
                .attr("text-anchor", "end")
                .text(label);
            svg.append("text")
                .attr("x", myChart._xPixels() - 5)
                .attr("y", yIntercept)
                .attr("text-anchor", "end")
                .attr("alignment-baseline", "middle")
                .text(parseInt(value));
        }

        /**
         * main draw function
         */
        function draw() {

            var margin = 50,
              width = 1024,
              height = 600;
            
            d3.select("body")
                .append("h2")
                .text("2015 Consumer Business Complaints in Brazil");

            d3.select("body")
                .append("h3")
                .text("How often and how fast consumers have their issues resolved in different states");

            var svg = dimple.newSvg("body", width, height);

            d3.tsv("data/data.tsv", function (data) {


                var rr = resolutionRate(data);
                var rt = resolutionTime(data);

                // fix data type
                data.forEach(function(d)    {
                    d.freq = parseFloat(d.freq);
                });

                var myChart = new dimple.chart(svg, data);
                myChart.setMargins(margin, margin, margin, margin);
                
                var x = myChart.addMeasureAxis("x", "freq");
                x.title = "Resolution rate";
                x.ticks = 4;
                x.tickFormat = PCT_FORMAT;
                x.overrideMin = 0.45;
                x.overrideMax = 0.90;

                var y = myChart.addMeasureAxis("y", "median");
                y.title = "Median resolution time in weeks";
                y.ticks = 4;
                y.overrideMax = 50;

                var z = myChart.addMeasureAxis("z", "n");

                
                var mySerie = myChart.addSeries("state", dimple.plot.bubble);
                myChart.defaultColors = [new dimple.color(CIRCLE_FILL_COLOR, CIRCLE_STROKE_COLOR, CIRCLE_OPACITY)];

                mySerie.getTooltipText = function (e) {
                    return [
                            "State: " + findStateByCode(data, e.aggField[0]),
                            "Resolution rate: " + d3.format(PCT_FORMAT)(e.cx),
                            "Median resolution time: " + parseInt(e.cy) + " weeks",
                            "# of complaints: " + d3.format(",.2r")(e.cz)
                        ];
                };

                mySerie.afterDraw = function (shape, data) {

                    var s = d3.select(shape);

                    //set minimum radius for the bubbles to avoid the state
                    // name to be bigger than the bubble
                    s.attr("r", Math.max(parseFloat(s.attr("r")), MIN_RADIUS));

                    // adds the states labels
                    svg.append("text")
                      .attr("x", parseFloat(s.attr("cx")))
                      .attr("y", parseFloat(s.attr("cy")))
                      .style("font-family", "sans-serif")
                      .style("font-size", "10px")
                      .style("text-anchor", "middle")
                      .style("alignment-baseline", "middle")
                      .style("pointer-events", "none")
                      .text(data.aggField);
                };

                myChart.assignColor("state", "white", "red", 0.5);
                myChart.draw();

                // mean resolution rate line
                addVerticalLine(svg, myChart, x, rr, "Mean resolution rate");

                // mean resolution time line
                addHorizontalLine(svg, myChart, y, rt, "Mean resolution time");

                // quadrants labels
                var leftMargin = myChart._xPixels();
                var topMargin = myChart._yPixels();
                var bottonMargin = myChart._yPixels() + myChart._heightPixels();
                var rightMargin = myChart._xPixels() + myChart._widthPixels();
                var labelMargin = 10;
                
                drawQuadrantLabels(svg, rightMargin - labelMargin, topMargin + labelMargin, "High", "Slow", "end", "hanging");
                drawQuadrantLabels(svg, rightMargin - labelMargin, bottonMargin - 25, "High", "Fast", "end", "baseline");
                drawQuadrantLabels(svg, leftMargin + labelMargin, bottonMargin - 25, "Low", "Fast", "start", "baseline");
                drawQuadrantLabels(svg, leftMargin + labelMargin, topMargin + labelMargin, "Low", "Slow", "start", "hanging");

                svg.append("circle")
                    .attr("cx", leftMargin)
                    .attr("cy", bottonMargin + 30)
                    .attr("r", 10)
                    .attr("oppacity", CIRCLE_OPACITY)
                    .attr("fill", CIRCLE_FILL_COLOR)
                    .attr("stroke", CIRCLE_STROKE_COLOR);
                svg.append("text")
                    .attr("x", leftMargin + 15)
                    .attr("y", bottonMargin + 30)
                    .attr("alignment-baseline", "middle")
                    .style("font-family", "sans-serif")
                    .style("font-size", "10px")
                    .text("The larger the circle, the more complaints in the state");
                
            });
        }

    </script>
    
  </head>
<body>
    <script type="text/javascript">
        draw();
    </script>
</body>
</html>
